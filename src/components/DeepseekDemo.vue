<template>
  <div class="min-h-screen bg-slate-50 py-8 px-1  sm:px-6 lg:px-8">
    <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
    <div class="max-w-7xl mx-auto mb-6 md:mb-12 text-center px-4">
      <div class="relative inline-block">
        <div class="absolute -inset-1 rounded-full bg-gradient-to-r from-purple-600 to-blue-500 opacity-30 blur-3xl"></div>
        <h1 class="relative text-3xl sm:text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-500 mb-2 md:mb-3">
          Vista AI å¹³å°
        </h1>
      </div>
      <p class="text-base md:text-lg text-gray-600 max-w-2xl mx-auto">
        æ™ºèƒ½ä½“AIå¯¹è¯ä¸å†…å®¹ç”Ÿæˆå·¥å…·
      </p>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸï¼šé…ç½®é¢æ¿å’ŒèŠå¤©é¢æ¿ -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-4 md:mb-8 px-4">
      <!-- é…ç½®é¢æ¿ -->
      <div class="bg-white rounded-xl shadow-md border border-gray-100 p-4 md:p-6 lg:w-full min-h-[500px] md:min-h-[650px] order-2 lg:order-1">
        <div class="flex items-center space-x-3 mb-6">
          <div class="bg-purple-100 p-2 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
            </svg>
          </div>
          <h2 class="text-xl font-semibold text-gray-800">ç³»ç»Ÿé…ç½®</h2>
        </div>

        <!-- API è®¾ç½®åŒºåŸŸ -->
        <div class="space-y-5 mb-6">
          <!-- API Key è¾“å…¥ -->
          <div>
            <label for="api-key" class="block text-sm font-medium text-gray-700 mb-1">API KEY</label>
            <div class="relative">
              <input type="password" id="api-key" v-model="apiKey" placeholder="è¾“å…¥æ‚¨çš„ Deepseek API Key" class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm" />
              <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v-1l1-1 1-1-.257-.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd" />
                </svg>
              </span>
            </div>
          </div>

          <!-- API URL è¾“å…¥ -->
          <div>
            <label for="api-url" class="block text-sm font-medium text-gray-700 mb-1">API åœ°å€</label>
            <div class="relative">
              <input type="text" id="api-url" v-model="apiUrl" placeholder="è¾“å…¥ API åœ°å€ï¼‰" class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm" />
              <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
              </span>
            </div>
          </div>
          <!-- æ¨¡å‹é€‰æ‹©è¾“å…¥ -->
          <div class="pt-5 border-t border-gray-200 mt-5">
            <label for="model-name" class="block text-sm font-medium text-gray-700 mb-1">AI æ¨¡å‹</label>
            <div class="relative">
              <input type="text" id="model-name" v-model="modelName" placeholder="è¾“å…¥æ¨¡å‹åç§°ï¼ˆä¾‹å¦‚ deepseek-chatï¼‰" class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm" />
              <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                </svg>
              </span>
            </div>

            <div class="mt-2 flex flex-wrap gap-2">
              <button @click="setModelName('deepseek-chat')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 rounded border border-gray-200 transition-colors">
                deepseek-chat
              </button>
              <button @click="setModelName('deepseek-coder')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 rounded border border-gray-200 transition-colors">
                deepseek-coder
              </button>
              <button @click="setModelName('QwQ-32B')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 rounded border border-gray-200 transition-colors">
                QwQ-32B
              </button>
              <button @click="setModelName('deepseek-lite')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 rounded border border-gray-200 transition-colors">
                deepseek-lite
              </button>
              <button @click="setModelName('deepseek-v2')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 rounded border border-gray-200 transition-colors">
                deepseek-v2
              </button>
            </div>

            <div class="mt-3 relative">
              <button @click="updateCurrentModel" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                </svg>
                æ›´æ–°å½“å‰æ¨¡å‹
              </button>

              <!-- æˆåŠŸæç¤º -->
              <div v-if="showingModelSuccess" class="absolute top-0 left-0 right-0 -mt-10 bg-green-100 text-green-700 text-sm px-3 py-1 rounded-md flex items-center justify-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                æ¨¡å‹å·²æ›´æ–°
              </div>
            </div>
          </div>
          <!-- API é£æ ¼é€‰æ‹© -->
          <div>
            <span class="block text-sm font-medium text-gray-700 mb-2">API é£æ ¼</span>
            <div class="grid grid-cols-2 gap-3">
              <div @click="setApiStyle('openai')" class="cursor-pointer relative p-4 rounded-lg border transition-all duration-200" :class="apiStyle === 'openai'
                  ? 'border-purple-500 bg-purple-50 shadow-sm'
                  : 'border-gray-200 hover:border-purple-300'
                ">
                <span class="absolute -top-1.5 -right-1.5" v-if="apiStyle === 'openai'">
                  <span class="flex h-5 w-5 items-center justify-center rounded-full bg-purple-600 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  </span>
                </span>
                <div class="mb-2 inline-flex items-center justify-center rounded-lg bg-purple-100 p-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-700" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                  </svg>
                </div>
                <h3 class="text-sm font-medium text-gray-900">
                  OpenAI å…¼å®¹æ ¼å¼
                </h3>
                <p class="mt-1 text-xs text-gray-500">
                  å…¼å®¹æ ‡å‡†OpenAIæ¥å£çš„å®¢æˆ·ç«¯
                </p>
              </div>

              <div @click="setApiStyle('adapter')" class="cursor-pointer relative p-4 rounded-lg border transition-all duration-200" :class="apiStyle === 'adapter'
                  ? 'border-purple-500 bg-purple-50 shadow-sm'
                  : 'border-gray-200 hover:border-purple-300'
                ">
                <span class="absolute -top-1.5 -right-1.5" v-if="apiStyle === 'adapter'">
                  <span class="flex h-5 w-5 items-center justify-center rounded-full bg-purple-600 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  </span>
                </span>
                <div class="mb-2 inline-flex items-center justify-center rounded-lg bg-purple-100 p-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-700" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd" />
                  </svg>
                </div>
                <h3 class="text-sm font-medium text-gray-900">
                  ai.createModel
                </h3>
                <p class="mt-1 text-xs text-gray-500">ç®€æ´çš„é€‚é…å™¨é£æ ¼æ¥å£</p>
              </div>
            </div>
          </div>
        </div>

        <!-- å‚æ•°æ§åˆ¶åŒºåŸŸ -->
        <div class="pt-5 border-t border-gray-200">
          <!-- æµå¼è¾“å‡ºå¼€å…³ -->
          <div class="flex items-center justify-between mb-5">
            <span class="text-sm font-medium text-gray-700">æµå¼è¾“å‡º</span>
            <button type="button" @click="streaming = !streaming" :class="streaming ? 'bg-purple-600' : 'bg-gray-200'" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
              <span :class="streaming ? 'translate-x-5' : 'translate-x-0'" class="pointer-events-none relative inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
                <span :class="streaming
                    ? 'opacity-0 duration-100 ease-out'
                    : 'opacity-100 duration-200 ease-in'
                  " class="absolute inset-0 flex h-full w-full items-center justify-center transition-opacity">
                  <svg class="h-3 w-3 text-gray-400" fill="none" viewBox="0 0 12 12">
                    <path d="M4 8l2-2m0 0l2-2M6 6L4 4m2 2l2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </span>
                <span :class="streaming
                    ? 'opacity-100 duration-200 ease-in'
                    : 'opacity-0 duration-100 ease-out'
                  " class="absolute inset-0 flex h-full w-full items-center justify-center transition-opacity">
                  <svg class="h-3 w-3 text-purple-600" fill="currentColor" viewBox="0 0 12 12">
                    <path d="M3.707 5.293a1 1 0 00-1.414 1.414l1.414-1.414zM5 8l-.707.707a1 1 0 001.414 0L5 8zm4.707-3.293a1 1 0 00-1.414-1.414l1.414 1.414zm-7.414 2l2 2 1.414-1.414-2-2-1.414 1.414zm3.414 2l4-4-1.414-1.414-4 4 1.414 1.414z" />
                  </svg>
                </span>
              </span>
            </button>
          </div>

          <!-- åˆ›æ„åº¦æ»‘å— -->
          <div class="mb-5">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">åˆ›æ„åº¦</span>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                {{ temperature.toFixed(1) }}
              </span>
            </div>
            <input type="range" min="0" max="1" step="0.1" v-model.number="temperature" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" />
            <div class="flex justify-between text-xs text-gray-500 mt-1">
              <span>ç²¾ç¡®</span>
              <span>åˆ›æ„</span>
            </div>
          </div>

          <!-- è¾“å‡ºé•¿åº¦æ»‘å— -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">è¾“å‡ºé•¿åº¦</span>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                {{ maxTokens }}
              </span>
            </div>
            <input type="range" min="500" max="4000" step="500" v-model.number="maxTokens" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" />
            <div class="flex justify-between text-xs text-gray-500 mt-1">
              <span>ç®€çŸ­</span>
              <span>è¯¦ç»†</span>
            </div>
          </div>
        </div>
      </div>

      <!-- èŠå¤©é¢æ¿ -->
      <div class="col-span-1 lg:col-span-2 flex flex-col bg-white rounded-xl shadow-md border border-gray-100 min-h-[500px] md:min-h-[650px] order-1 lg:order-2">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="flex items-center justify-between px-4 py-3 md:px-6 md:py-4 border-b border-gray-200">
          <button @click="activeTab = 'output'" class="px-4 py-3 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors" :class="activeTab === 'output'
              ? 'text-purple-600 border-purple-600'
              : 'text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300'
            ">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V9z" clip-rule="evenodd" />
            </svg>
            å¯¹è¯å†…å®¹
          </button>
          <button @click="activeTab = 'thinking'" class="px-4 py-3 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors" :class="activeTab === 'thinking'
              ? 'text-purple-600 border-purple-600'
              : 'text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300'
            ">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
            </svg>
            æ€ç»´è¿‡ç¨‹
          </button>

          <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
          <div v-if="isProcessing" class="ml-auto flex items-center gap-2 px-4">
            <div class="w-24 bg-gray-200 rounded-full h-1.5 overflow-hidden">
              <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-1.5 rounded-full" :style="{ width: streamProgress + '%' }"></div>
            </div>
            <span class="text-xs text-gray-500">{{ streamProgress }}%</span>
          </div>
        </div>

        <!-- æ¶ˆæ¯å†…å®¹åŒºåŸŸ -->
        <div class="flex-1 overflow-hidden">
          <!-- å¯¹è¯å†…å®¹ -->
          <div v-show="activeTab === 'output'" class="chat-container h-full max-h-[650px]" ref="chatContainer" @scroll="handleScroll">
            <!-- æ€è€ƒæç¤º -->
            <div v-if="isThinking" class="flex items-center space-x-3 p-4 mb-4 bg-blue-50 rounded-lg border border-blue-100 animate-pulse thinking-indicator">
              <div class="relative w-8 h-8 flex-shrink-0">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-400 to-blue-500 rounded-full animate-ping opacity-75"></div>
                <div class="relative bg-white rounded-full p-1.5 flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947z" clip-rule="evenodd" />
                  </svg>
                </div>
              </div>
              <div>
                <div class="text-sm font-medium text-blue-700">AIæ­£åœ¨æ€è€ƒä¸­</div>
                <div class="text-xs text-blue-500">æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜ï¼Œå¹¶æ„å»ºè§£ç­”æ€è·¯ï¼Œè¯·ç¨å€™...</div>
              </div>
            </div>

            <div v-for="(item, index) in conversationHistory" :key="index" :class="[
              'flex mb-6',
              item.role === 'user' ? 'justify-end' : 'justify-start',
            ]">
              <div :class="[
                'flex max-w-[85%] gap-3',
                item.role === 'user' ? 'flex-row-reverse' : 'flex-row',
              ]">
                <div v-if="item.role === 'user'" class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 ring-2 ring-purple-200">
                  <img src="@/assets/user.jpg" alt="User" class="w-full h-full object-cover" />
                </div>
                <div v-else class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white text-lg">
                  ğŸ¤–
                </div>

                <div :class="[
                  'relative group rounded-2xl px-4 py-3 text-[15px] leading-6',
                  item.role === 'user'
                    ? 'bg-purple-600 text-white rounded-tr-none'
                    : 'bg-gray-100 text-gray-800 rounded-tl-none'
                ]">
                  <div :class="[
                    'text-xs font-medium mb-1',
                    item.role === 'user'
                      ? 'text-purple-100'
                      : 'text-gray-500'
                  ]">
                    {{ item.role === "user" ? "æ‚¨" : "æ¨¡å‹" }}
                  </div>

                  <!-- æ­£åœ¨æ€è€ƒæç¤º - æ˜¾ç¤ºåœ¨æœ€åä¸€æ¡AIå›å¤ä¸­ -->
                  <div v-if="isThinking && item.role === 'assistant' && index === conversationHistory.length - 1"
                       class="flex flex-col space-y-2 mb-2">
                    <div class="flex items-center space-x-2 text-sm text-blue-600 font-medium">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                      <span>æ­£åœ¨æ€è€ƒ...</span>
                    </div>
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 text-sm text-blue-700 leading-relaxed">
                      <div class="flex items-center space-x-1.5 mb-2">
                        <div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse"></div>
                        <div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 300ms"></div>
                        <div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 600ms"></div>
                      </div>
                      <p class="text-xs">AIæ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜ï¼Œå¹¶æ„å»ºè§£ç­”æ€è·¯ï¼Œè¯·ç¨å€™...</p>
                    </div>
                  </div>

                  <!-- æ‰‹åŠ¨åœæ­¢æç¤º - æ˜¾ç¤ºåœ¨æœ€åä¸€æ¡AIå›å¤ä¸­ä¸”isLastMessageStoppedä¸ºtrue -->
                  <div v-if="isLastMessageStopped && item.role === 'assistant' && index === conversationHistory.length - 1"
                       class="flex items-center space-x-2 p-2 mb-3 bg-amber-50 rounded-lg border border-amber-100 text-amber-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs font-medium">å›ç­”å·²è¢«æ‰‹åŠ¨åœæ­¢</span>
                  </div>

                  <div :class="[
                    'prose prose-sm max-w-none',
                    item.role === 'user' ? 'prose-invert' : 'prose-gray',
                    '[&>:first-child]:mt-0',
                    '[&>:last-child]:mb-0',
                    '[&>p]:my-3',
                    '[&>ul]:my-3 [&>ul>li]:my-1',
                    '[&>ol]:my-3 [&>ol>li]:my-1',
                    '[&>blockquote]:my-3 [&>blockquote]:border-l-4 [&>blockquote]:pl-3 [&>blockquote]:italic',
                    '[&>pre]:my-3 [&>pre]:bg-gray-800/5 [&>pre]:p-3 [&>pre]:rounded-lg',
                    '[&>h1]:text-lg [&>h1]:font-semibold [&>h1]:my-4',
                    '[&>h2]:text-base [&>h2]:font-semibold [&>h2]:my-3',
                    '[&>h3]:text-sm [&>h3]:font-semibold [&>h3]:my-2',
                    '[&>code]:px-1.5 [&>code]:py-0.5 [&>code]:rounded [&>code]:text-sm',
                    item.role === 'user'
                      ? '[&>code]:bg-purple-500/30 [&>blockquote]:border-purple-400/50'
                      : '[&>code]:bg-gray-200 [&>blockquote]:border-gray-300'
                  ]" v-html="formatText(item.content)"></div>

                  <button
                    @click="copyMessage(item.content)"
                    class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-1.5 rounded-lg hover:bg-black/5 text-gray-500 hover:text-gray-700"
                    :title="copySuccess ? 'å¤åˆ¶æˆåŠŸï¼' : 'å¤åˆ¶å†…å®¹'"
                  >
                    <svg v-if="!copySuccess" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                      <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                    </svg>
                    <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- æ‰“å­—åŠ¨ç”»æŒ‡ç¤ºå™¨ -->
          <!--   <div v-if="isProcessing && !isThinking && conversationHistory.length > 0" class="flex mb-6 justify-start">
              <div class="flex max-w-[85%] gap-3 flex-row">
                <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white text-lg">
                  ğŸ¤–
                </div>
                <div class="relative rounded-2xl px-4 py-3 bg-gray-100 text-gray-800 rounded-tl-none">
                  <div class="text-xs font-medium mb-2 text-gray-500">
                    æ¨¡å‹
                  </div>
                  <div class="flex space-x-1.5">
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                  </div>
                </div>
              </div>
            </div> -->

            <!-- ç©ºçŠ¶æ€ -->
            <div v-if="conversationHistory.length === 0" class="flex flex-col items-center justify-center min-h-full p-8 text-center">
              <div class="w-20 h-20 rounded-full bg-indigo-50/30 flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-300" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                </svg>
              </div>
              <p class="text-xl font-semibold text-indigo-600 mb-2">
                å¼€å§‹æé—®ï¼Œæ¢ç´¢AIçš„èƒ½åŠ›
              </p>
              <p class="text-gray-600 mb-8 max-w-md">
                è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä½“éªŒAIçš„æ™ºèƒ½å¯¹è¯èƒ½åŠ›
              </p>

              <!-- ç¤ºä¾‹é—®é¢˜éƒ¨åˆ† -->
              <div class="space-y-6 w-full max-w-2xl">
                <!-- çƒ­é—¨è¯é¢˜åŒºåŸŸ -->
                <div>
                  <div class="flex items-center gap-2 mb-3">
                    <div class="bg-red-100 p-1.5 rounded-lg">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd" />
                      </svg>
                    </div>
                    <h3 class="text-sm font-medium text-gray-700">çƒ­é—¨è¯é¢˜</h3>
                    <button @click="refreshHotTopics" class="ml-auto text-xs text-indigo-600 hover:text-indigo-800 transition-colors flex items-center gap-1">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                      </svg>
                      <span>åˆ·æ–°</span>
                    </button>
                  </div>
                  <div v-if="isLoadingHotTopics" class="flex justify-center py-4">
                    <div class="w-6 h-6 border-2 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin"></div>
                  </div>
                  <div v-else class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <button
                      v-for="(topic, index) in hotTopics"
                      :key="index"
                      @click="setExampleQuestion(topic)"
                      class="w-full px-3 py-2 text-left bg-gradient-to-r from-red-50 to-orange-50 border border-red-100 rounded-lg hover:shadow-sm transition-all overflow-hidden text-xs text-gray-700 hover:from-red-100 hover:to-orange-100"
                    >
                      <div class="flex items-center gap-1.5">
                        <span class="flex-shrink-0 w-4 h-4 rounded-full bg-red-500/10 text-red-500 text-[10px] font-bold flex items-center justify-center">
                          {{index + 1}}
                        </span>
                        <span class="truncate">{{topic}}</span>
                      </div>
                    </button>
                  </div>
                </div>

                <!-- é¢„è®¾é—®é¢˜åŒºåŸŸ -->
                <div>
                  <div class="flex items-center gap-2 mb-3">
                    <div class="bg-indigo-100 p-1.5 rounded-lg">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                      </svg>
                    </div>
                    <h3 class="text-sm font-medium text-gray-700">é¢„è®¾é—®é¢˜</h3>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <button
                      @click="setExampleQuestion('ä»‹ç»ä¸€ä¸‹å”ä»£è¯—äººæç™½')"
                      class="w-full px-4 py-3 text-left bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-colors overflow-hidden text-sm text-gray-700"
                    >
                      <span class="block truncate">ä»‹ç»ä¸€ä¸‹å”ä»£è¯—äººæç™½</span>
                    </button>
                    <button
                      @click="setExampleQuestion('å¦‚ä½•ä½¿ç”¨Reactåˆ›å»ºä¸€ä¸ªTodoListç»„ä»¶ï¼Ÿ')"
                      class="w-full px-4 py-3 text-left bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-colors overflow-hidden text-sm text-gray-700"
                    >
                      <span class="block truncate">å¦‚ä½•ä½¿ç”¨Reactåˆ›å»ºTodoList</span>
                    </button>
                    <button
                      @click="setExampleQuestion('è§£é‡Šé‡å­è®¡ç®—çš„åŸºæœ¬åŸç†')"
                      class="w-full px-4 py-3 text-left bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-colors overflow-hidden text-sm text-gray-700"
                    >
                      <span class="block truncate">é‡å­è®¡ç®—çš„åŸºæœ¬åŸç†</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- æ€ç»´è¿‡ç¨‹ -->
          <div v-show="activeTab === 'thinking'" class="thinking-process h-full overflow-y-auto p-6 max-h-[650px]" ref="thinkingContainer" @scroll="handleScroll">
            <!-- æœ‰æ€ç»´å†…å®¹æ—¶æ˜¾ç¤º -->
            <div v-if="reasoningContent" class="relative">
              <div class="absolute -inset-1 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-xl blur-xl"></div>
              <div class="relative p-6 bg-white border border-gray-100 rounded-xl shadow-sm">
                <!-- æ€ç»´å›¾æ ‡å’Œæ ‡é¢˜ -->
                <div class="flex items-center gap-3 mb-4 pb-4 border-b border-gray-100">
                  <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-gray-900">æ€ç»´é“¾è·¯</h3>
                    <p class="text-sm text-gray-500">AIçš„åˆ†æå’Œæ¨ç†è¿‡ç¨‹</p>
                  </div>
                </div>
                <!-- æ€ç»´å†…å®¹ -->
                <div class="prose prose-sm max-w-none text-gray-600">
                  <div class="space-y-4" v-html="formatText(reasoningContent)"></div>
                </div>
              </div>
            </div>

            <!-- æ­£åœ¨åŠ è½½æ€ç»´è¿‡ç¨‹ -->
            <div v-else-if="isThinking" class="relative">
              <div class="absolute -inset-1 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-xl blur-xl"></div>
              <div class="relative p-8 bg-white border border-gray-100 rounded-xl shadow-sm">
                <div class="flex flex-col items-center justify-center">
                  <!-- æ€è€ƒåŠ¨ç”» -->
                  <div class="relative w-16 h-16 mb-6">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full animate-pulse"></div>
                    <div class="absolute inset-1 bg-white rounded-full flex items-center justify-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600 animate-bounce" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947z" clip-rule="evenodd" />
                      </svg>
                    </div>
                  </div>
                  <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-3">
                    AIæ­£åœ¨æ€è€ƒ
                  </h3>
                  <p class="text-gray-500 text-center max-w-md">
                    æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜ï¼Œæ„å»ºé€»è¾‘é“¾è·¯ï¼Œç”Ÿæˆæœ€ä½³ç­”æ¡ˆ...
                  </p>
                </div>
              </div>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div v-else class="relative">
              <div class="absolute -inset-1 bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl blur-xl"></div>
              <div class="relative p-8 bg-white border border-gray-100 rounded-xl shadow-sm">
                <div class="flex flex-col items-center justify-center text-center">
                  <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <h3 class="text-xl font-semibold text-gray-900 mb-3">
                    æ¢ç´¢AIçš„æ€ç»´è¿‡ç¨‹
                  </h3>
                  <p class="text-gray-500 max-w-md">
                    åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥çœ‹åˆ°AIæ˜¯å¦‚ä½•åˆ†æé—®é¢˜ã€æ„å»ºé€»è¾‘é“¾è·¯ï¼Œå¹¶æœ€ç»ˆå¾—å‡ºç­”æ¡ˆçš„ã€‚å‘é€ä¸€ä¸ªé—®é¢˜ï¼Œå¼€å§‹æ¢ç´¢AIçš„æ€ç»´ä¸–ç•Œå§ï¼
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div v-if="error" class="mx-4 mt-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
          <p class="text-sm text-red-700">{{ error }}</p>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="p-3 md:p-4 border-t border-gray-200 mt-auto bg-gray-50">
          <div class="flex flex-col">
            <div class="relative mb-2">
              <textarea
                id="message-input"
                v-model="userInput"
                class="block w-full resize-none border border-gray-300 rounded-xl px-3 md:px-4 py-2 md:py-3 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm min-h-[80px] md:min-h-[100px] pr-12 transition-shadow shadow-sm hover:shadow"
                placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–éœ€æ±‚..."
                :disabled="isProcessing"
                @keyup.ctrl.enter="sendMessage"
              ></textarea>
              <div class="absolute bottom-3 right-3 hidden md:flex items-center gap-2 text-xs text-gray-400">
                <kbd class="px-2 py-1 bg-white rounded border border-gray-300 shadow-sm">Ctrl</kbd>
                <span>+</span>
                <kbd class="px-2 py-1 bg-white rounded border border-gray-300 shadow-sm">Enter</kbd>
                <span>å‘é€</span>
              </div>
            </div>

            <div class="flex flex-wrap md:flex-nowrap justify-between items-center gap-2">
              <div class="w-full md:w-auto order-2 md:order-1">
                <button class="w-full md:w-auto inline-flex items-center justify-center gap-2 px-3 py-2 text-sm text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" title="æ¸…ç©ºå¯¹è¯" @click="clearHistory">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                  </svg>
                  <span>æ¸…ç©ºå¯¹è¯</span>
                </button>
              </div>

              <div class="w-full md:w-auto order-1 md:order-2">
                <!-- å‘é€æ¶ˆæ¯æŒ‰é’® -->
                <button v-if="!isProcessing" @click="sendMessage" :disabled="!userInput.trim()" class="w-full md:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-sm font-medium rounded-lg transition-all disabled:bg-gradient-to-r disabled:from-purple-300 disabled:to-purple-400 disabled:opacity-70 disabled:text-purple-100 disabled:shadow-none disabled:cursor-not-allowed bg-gradient-to-r from-purple-600 to-purple-700 text-white shadow-sm hover:shadow-md">
                  <span class="flex items-center gap-2">
                    <span>å‘é€</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                  </span>
                </button>

                <!-- ç»ˆæ­¢ç”ŸæˆæŒ‰é’® -->
                <button v-else @click="stopGeneration" class="w-full md:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-sm font-medium rounded-lg transition-all bg-gradient-to-r from-red-500 to-red-600 text-white shadow-sm hover:shadow-md">
                  <span class="flex items-center gap-2">
                    <span>åœæ­¢ç”Ÿæˆ</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" />
                    </svg>
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä»£ç ç¤ºä¾‹åŒºåŸŸ -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden mb-8 mx-4">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center space-x-3">
          <div class="bg-purple-100 p-2 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-800">ä»£ç ç¤ºä¾‹</h3>
        </div>
        <div class="flex items-center space-x-2 text-gray-500 text-sm">
          <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-medium">{{
            apiStyle === "openai" ? "OpenAIå…¼å®¹æ ¼å¼" : "ai.createModelæ ·å¼"
          }}</span>
        </div>
      </div>
      <div class="bg-gray-900 p-4 overflow-x-auto text-gray-300 text-sm font-mono whitespace-pre">
        {{ currentCode }}
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, nextTick, onMounted } from "vue";
import { useDeepseekApi } from "../hooks/useDeepseekApi";
import { usePromptStore } from "../stores/prompt";
import { useApiStore } from '../stores/api';
// @ts-ignore
import MarkdownIt from 'markdown-it';
import hljs from 'highlight.js';
import 'highlight.js/styles/github-dark.css';
// å¼•å…¥axiosç”¨äºå‘é€HTTPè¯·æ±‚
import axios from 'axios';

// åˆ›å»º markdown-it å®ä¾‹
const md = new MarkdownIt({
  html: true,
  linkify: true,
  typographer: true,
  breaks: true,
  highlight: function (str: string, lang: string): string {
    if (lang && hljs.getLanguage(lang)) {
      try {
        return '<pre class="hljs language-' + lang + '"><code>' +
          hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
          '</code></pre>';
      } catch (__) {
        // æ•è·é”™è¯¯ä½†ä¸å¤„ç†
      }
    }
    return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
  }
});

// å®šä¹‰å±æ€§
const props = defineProps({
  apiBaseUrl: {
    type: String,
    default: "",
  },
  initialPrompt: {
    type: String,
    default: ''
  }
});

// åŸºæœ¬è®¾ç½®
const userInput = ref(""); // ç§»é™¤é»˜è®¤çš„ç”¨æˆ·è¾“å…¥æ–‡æœ¬
const streaming = ref(true);
const temperature = ref(0.7);
const maxTokens = ref(2000);
const activeTab = ref("output");
const apiStyle = ref("openai"); // é»˜è®¤ä½¿ç”¨OpenAIå…¼å®¹æ ¼å¼
const modelName = ref(localStorage.getItem('modelName') || "deepseek-ai/DeepSeek-R1-Distill-Qwen-7B"); // æ·»åŠ æ¨¡å‹åç§°çŠ¶æ€
const isSending = ref(false); // æ·»åŠ å‘é€çŠ¶æ€æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤å‘é€
const hotTopics = ref<string[]>([]); // æ·»åŠ çƒ­æœè¯é¢˜æ•°ç»„
const isLoadingHotTopics = ref(false); // æ·»åŠ çƒ­æœåŠ è½½çŠ¶æ€
const showingModelSuccess = ref(false); // æ·»åŠ æ¨¡å‹æ›´æ–°æˆåŠŸæç¤ºæ ‡å¿—

// æ·»åŠ æ»šåŠ¨ç›¸å…³å˜é‡
const shouldAutoScroll = ref(true); // æ˜¯å¦åº”è¯¥è‡ªåŠ¨æ»šåŠ¨
const isUserScrolling = ref(false); // ç”¨æˆ·æ˜¯å¦æ­£åœ¨æ»šåŠ¨
const chatContainer = ref<HTMLElement | null>(null); // èŠå¤©å®¹å™¨å¼•ç”¨
const thinkingContainer = ref<HTMLElement | null>(null); // æ€è€ƒå®¹å™¨å¼•ç”¨
let scrollTimer: number | null = null; // æ»šåŠ¨è®¡æ—¶å™¨

// è·å–æç¤ºè¯storeå’ŒAPI Store
const promptStore = usePromptStore();
const apiStore = useApiStore();

// ä½¿ç”¨API Hooks
const {
  apiKey,
  apiUrl,
  isProcessing,
  error,
  streamProgress,
  conversationHistory,
  reasoningContent,
  isThinking,
  isLastMessageStopped, // æ·»åŠ å¼•ç”¨æ˜¯å¦æ‰‹åŠ¨åœæ­¢çš„çŠ¶æ€
  sendChatMessage,
  streamChatMessage,
  clearHistory,
  stopGeneration // æ·»åŠ å¼•ç”¨ç»ˆæ­¢ç”Ÿæˆæ–¹æ³•
} = useDeepseekApi();

// ç¡®ä¿API Keyä»localStorageä¸­åŠ è½½
if (!apiKey.value) {
  const savedApiKey = localStorage.getItem('apiKey');
  if (savedApiKey) {
    apiKey.value = savedApiKey;
    console.log('ä»localStorageåŠ è½½API KeyæˆåŠŸ');
  }
}

// åœ¨ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–æ•°æ®
onMounted(() => {
  // è®¾ç½®API URL
  if (props.apiBaseUrl) {
    apiUrl.value = props.apiBaseUrl;
  }

  // ç¡®ä¿åˆå§‹çŠ¶æ€ä¸‹æ»šåŠ¨åˆ°åº•éƒ¨
  nextTick(() => {
    scrollToBottom(true);
  });

  // åœ¨ç»„ä»¶æŒ‚è½½æ—¶è·å–çƒ­æœè¯é¢˜
  fetchHotTopics();

  // åªæœ‰å½“promptåº“ä¸­æœ‰æç¤ºè¯æ—¶æ‰è®¾ç½®è¾“å…¥å†…å®¹
  if (promptStore.promptText) {
    userInput.value = promptStore.promptText;
    // æ¸…é™¤storeä¸­çš„æç¤ºè¯ï¼Œé¿å…é‡å¤ä½¿ç”¨
    promptStore.clearPromptText();
  } else if (props.initialPrompt) {
    // å¦‚æœæœ‰åˆå§‹æç¤ºè¯ï¼Œåˆ™ä½¿ç”¨å®ƒ
    userInput.value = props.initialPrompt;
  }
});

// è®¾ç½®ç¤ºä¾‹é—®é¢˜çš„å‡½æ•°
function setExampleQuestion(question: string) {
  userInput.value = question;
  // å°†ç„¦ç‚¹è®¾ç½®åˆ°è¾“å…¥æ¡†
  nextTick(() => {
    const inputElement = document.getElementById('message-input');
    if (inputElement) {
      inputElement.focus();
    }
  });
}

// ç›‘å¬apiBaseUrlå˜åŒ–
watch(
  () => props.apiBaseUrl,
  (newUrl) => {
    if (newUrl) {
      apiUrl.value = newUrl;
    }
  },
  { immediate: true }
);

// è®¡ç®—å½“å‰ä»£ç ç¤ºä¾‹
const currentCode = computed(() => {
  if (apiStyle.value === "openai") {
    return `import DeepseekClient from './services/DeepseekClient';

// åˆ›å»ºå®¢æˆ·ç«¯
const client = new DeepseekClient({
  apiKey: 'YOUR_API_KEY',
  baseURL: 'YOUR_API_ENDPOINT',
  model: 'deepseek-r1'
});

// åˆ›å»ºèŠå¤©å®Œæˆè¯·æ±‚
const stream = await client.chat.completions.create({
  messages: [
    { role: 'user', content: '${userInput.value}' }
  ],
  stream: ${streaming.value},
  temperature: ${temperature.value},
  max_tokens: ${maxTokens.value}
});

// å¤„ç†æµå¼å“åº”
for await (const chunk of stream) {
  // å¤„ç†æ€ç»´é“¾å†…å®¹
  const reasoning = chunk.choices?.[0]?.delta?.reasoning_content;
  if (reasoning) console.log('æ€è€ƒ:', reasoning);

  // å¤„ç†ç”Ÿæˆå†…å®¹
  const content = chunk.choices?.[0]?.delta?.content;
  if (content) console.log('å›ç­”:', content);
}`;
  } else {
    return `import ai from './services/DeepseekAdapter';

// åˆ›å»ºæ¨¡å‹
const aiModel = ai.createModel("deepseek", {
  apiKey: 'YOUR_API_KEY',
  baseURL: 'YOUR_API_ENDPOINT'
});

// ${streaming.value ? "æµå¼" : ""}æ–‡æœ¬ç”Ÿæˆ
${streaming.value
        ? `const res = await aiModel.streamText({
  model: "deepseek-r1",
  messages: [
    { role: "user", content: "${userInput.value}" }
  ],
  temperature: ${temperature.value},
  max_tokens: ${maxTokens.value}
});

// å¤„ç†æµå¼å“åº”
for await (const data of res.dataStream) {
  // æ€ç»´é“¾å†…å®¹
  const think = (data?.choices?.[0]?.delta)?.reasoning_content;
  if (think) console.log('æ€è€ƒ:', think);

  // ç”Ÿæˆæ–‡æœ¬å†…å®¹
  const text = (data?.choices?.[0]?.delta)?.content;
  if (text) console.log('å›ç­”:', text);
}`
        : `const res = await aiModel.generateText({
  model: "deepseek-r1",
  messages: [
    { role: "user", content: "${userInput.value}" }
  ],
  temperature: ${temperature.value},
  max_tokens: ${maxTokens.value}
});

console.log('å›ç­”:', res.text);
console.log('æ€è€ƒ:', res.reasoning);`
      }`;
  }
});

// è®¾ç½®APIé£æ ¼
function setApiStyle(style: "openai" | "adapter") {
  apiStyle.value = style;
}

// è®¾ç½®æ¨¡å‹åç§°
function setModelName(name: string) {
  modelName.value = name;
}

// æ›´æ–°å½“å‰ä½¿ç”¨çš„æ¨¡å‹
function updateCurrentModel() {
  if (modelName.value) {
    // ä¿å­˜æ¨¡å‹åç§°åˆ°localStorage
    localStorage.setItem('modelName', modelName.value);

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    showingModelSuccess.value = true;
    setTimeout(() => {
      showingModelSuccess.value = false;
    }, 2000);
  }
}

// æ·»åŠ é˜²æŠ–å‡½æ•°å·¥å…·
function debounce(fn: Function, delay = 300) {
  let timer: ReturnType<typeof setTimeout> | null = null;
  return function(this: any, ...args: any[]) {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => {
      fn.apply(this, args);
      timer = null;
    }, delay);
  };
}

// æ”¹è¿›æ»šåŠ¨ç›‘å¬å¤„ç†å‡½æ•°
function handleScroll(event: Event) {
  const container = event.target as HTMLElement;
  const scrollOffset = container.scrollHeight - container.scrollTop - container.clientHeight;

  // æ›´ç²¾ç¡®åœ°æ£€æµ‹æ˜¯å¦åœ¨åº•éƒ¨ï¼ˆä½¿ç”¨æ›´å°çš„é˜ˆå€¼ï¼‰
  const isAtBottom = scrollOffset < 50;

  // åªæœ‰å½“ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨ä¸”ä¸åœ¨åº•éƒ¨æ—¶ï¼Œæ‰ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨
  if (!isThinking.value && !isProcessing.value) {
    shouldAutoScroll.value = isAtBottom;
  }

  // æ ‡è®°ç”¨æˆ·æ­£åœ¨æ»šåŠ¨
  isUserScrolling.value = true;
  if (scrollTimer) clearTimeout(scrollTimer);

  // è®¾ç½®æ»šåŠ¨è¶…æ—¶ï¼Œè®°å½•æ»šåŠ¨åœæ­¢çŠ¶æ€
  scrollTimer = setTimeout(() => {
    isUserScrolling.value = false;
  }, 1000) as unknown as number;
}

// é˜²æŠ–å¤„ç†çš„æ»šåŠ¨åˆ°åº•éƒ¨å‡½æ•°
const debouncedScrollToBottom = debounce((forceScroll = false) => {
  const container = activeTab.value === 'output' ? chatContainer.value : thinkingContainer.value;
  if (!container) return;

  // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ»šåŠ¨åˆ°åº•éƒ¨:
  // 1. å¼ºåˆ¶æ»šåŠ¨
  // 2. åº”è¯¥è‡ªåŠ¨æ»šåŠ¨ä¸”æ²¡æœ‰ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨æ“ä½œ
  // 3. æ­£åœ¨æ€è€ƒæˆ–å¤„ç†æ¶ˆæ¯æ—¶
  const shouldScroll = forceScroll ||
                      (shouldAutoScroll.value && !isUserScrolling.value) ||
                      isThinking.value ||
                      isProcessing.value;

  if (shouldScroll) {
    // æ·»åŠ å¹³æ»‘æ»šåŠ¨æ•ˆæœ
    container.style.scrollBehavior = 'smooth';

    // è®¡ç®—æ˜¯å¦å·²ç»æ¥è¿‘åº•éƒ¨
    const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 150;

    // å¦‚æœä¸åœ¨åº•éƒ¨é™„è¿‘ï¼Œå…ˆè·³è½¬åˆ°æ¥è¿‘åº•éƒ¨çš„ä½ç½®ï¼Œå†å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
    if (!isNearBottom) {
      container.style.scrollBehavior = 'auto';
      container.scrollTop = container.scrollHeight - container.clientHeight - 100;

      // çŸ­æš‚å»¶è¿Ÿåå¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
      setTimeout(() => {
        container.style.scrollBehavior = 'smooth';
        container.scrollTop = container.scrollHeight;
      }, 10);
    } else {
      // å·²ç»åœ¨åº•éƒ¨é™„è¿‘ï¼Œç›´æ¥å¹³æ»‘æ»šåŠ¨
      container.scrollTop = container.scrollHeight;
    }

    // æ»šåŠ¨åæ¢å¤é»˜è®¤æ»šåŠ¨è¡Œä¸º
    setTimeout(() => {
      if (container) {
        container.style.scrollBehavior = 'auto';
      }
    }, 500);
  }
}, 50); // å‡å°‘å»¶è¿Ÿæ—¶é—´ï¼Œä½¿æ»šåŠ¨æ›´åŠ åŠæ—¶

// æ›¿æ¢åŸæ¥çš„scrollToBottomå‡½æ•°
function scrollToBottom(forceScroll = false) {
  debouncedScrollToBottom(forceScroll);
}

// ä¼˜åŒ–ç›‘å¬å¯¹è¯å†å²å’Œæ€ç»´å†…å®¹å˜åŒ–çš„é€»è¾‘
watch([conversationHistory, reasoningContent], async () => {
  await nextTick();

  // å¦‚æœæ˜¯åˆå§‹çŠ¶æ€æˆ–å†…å®¹æ›´æ–°ä¸”æœªè¢«ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨è¿‡ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
  if (conversationHistory.length <= 1 || !isUserScrolling.value) {
    debouncedScrollToBottom(true);
    return;
  }

  // æ€ç»´è¿‡ç¨‹åŒºåŸŸéœ€è¦æ›´æ™ºèƒ½çš„æ»šåŠ¨
  if (activeTab.value === 'thinking' && reasoningContent.value) {
    // å¯¹äºæ€ç»´è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¼˜åŒ–æ»šåŠ¨é€»è¾‘ï¼Œè§£å†³å¡åœ¨åº•éƒ¨çš„é—®é¢˜
    const container = thinkingContainer.value;
    if (container) {
      // å¦‚æœæ­£åœ¨å¤„ç†æ¶ˆæ¯æˆ–æ€è€ƒä¸­ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
      if (isProcessing.value || isThinking.value) {
        debouncedScrollToBottom(true);
      } else {
        // åˆ¤æ–­æ˜¯å¦å·²ç»åœ¨åº•éƒ¨é™„è¿‘
        const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 150;

        // å¦‚æœåœ¨åº•éƒ¨é™„è¿‘æˆ–è€…åº”è¯¥è‡ªåŠ¨æ»šåŠ¨ï¼Œåˆ™æ‰§è¡Œæ»šåŠ¨
        if (isNearBottom || shouldAutoScroll.value) {
          debouncedScrollToBottom(true);
        }
      }
    }
  } else if (shouldAutoScroll.value || isProcessing.value || isThinking.value) {
    // å¯¹äºèŠå¤©å†…å®¹ï¼Œå¦‚æœåº”è¯¥è‡ªåŠ¨æ»šåŠ¨æˆ–æ­£åœ¨å¤„ç†æ¶ˆæ¯ï¼Œåˆ™æ»šåŠ¨åˆ°åº•éƒ¨
    debouncedScrollToBottom(true);
  }
}, { deep: true });

// ç›‘å¬æ ‡ç­¾åˆ‡æ¢ï¼Œæ™ºèƒ½æ»šåŠ¨
watch(activeTab, async () => {
  await nextTick();
  // åˆ‡æ¢æ ‡ç­¾æ—¶æ€»æ˜¯æ»šåŠ¨åˆ°åº•éƒ¨
  debouncedScrollToBottom(true);
});

// å‘é€æ¶ˆæ¯
async function sendMessage() {
  // å¦‚æœå·²ç»åœ¨å‘é€ä¸­ï¼Œç›´æ¥è¿”å›
  if (isSending.value) {
    console.log("å·²ç»åœ¨å‘é€è¿‡ç¨‹ä¸­ï¼Œå¿½ç•¥æ­¤æ¬¡ç‚¹å‡»");
    return;
  }

  // è®¾ç½®å‘é€çŠ¶æ€ä¸ºtrue
  isSending.value = true;

  try {
    // ç¡®ä¿è¾“å…¥ä¸ä¸ºç©º
    if (!userInput.value.trim()) {
      return;
    }

    // å¦‚æœæ²¡æœ‰API Keyï¼Œä¸´æ—¶è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼
    if (!apiKey.value) {
      apiKey.value = "temp_key_for_testing";
      console.log("ä½¿ç”¨ä¸´æ—¶API Key");
    }

    // è®¾ç½®æ´»åŠ¨æ ‡ç­¾ä¸ºè¾“å‡º
    activeTab.value = "output";

    // æ¸…é™¤æ—§çš„æ€ç»´å†…å®¹
    reasoningContent.value = "";

    // ä¿å­˜ç”¨æˆ·è¾“å…¥å¹¶æ¸…ç©ºè¾“å…¥æ¡†
    const input = userInput.value;
    userInput.value = "";

    // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
    await nextTick();
    scrollToBottom();

    // æ ¹æ®æ˜¯å¦æµå¼å¤„ç†é€‰æ‹©ä¸åŒçš„å‘é€æ–¹æ³•
    if (streaming.value) {
      isThinking.value = true;
      await streamChatMessage(input, {
        onContent: (content: string) => {
          // å†…å®¹æ›´æ–°åæ»šåŠ¨åˆ°åº•éƒ¨
          nextTick(() => {
            scrollToBottom();
          });
        },
        onReasoning: (content: string) => {
          // åˆ¤æ–­æ˜¯å¦æœ‰æ€ç»´å†…å®¹ï¼Œå¦‚æœæœ‰åˆ™è®¾ç½®æ´»åŠ¨æ ‡ç­¾
          if (content && !reasoningContent.value) {
            // ä¸å†è‡ªåŠ¨åˆ‡æ¢åˆ°thinkingæ ‡ç­¾
            // activeTab.value = "thinking";
          }
        },
        onError: (error: any) => {
          console.error("æµå¼è¯·æ±‚å‡ºé”™:", error);
        },
        onComplete: () => {
          isThinking.value = false;
        }
      }, {
        temperature: temperature.value,
        maxTokens: maxTokens.value,
        model: modelName.value
      });
    } else {
      await sendChatMessage(input, {
        temperature: temperature.value,
        maxTokens: maxTokens.value,
        model: modelName.value
      });
    }

    // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
    await nextTick();
    scrollToBottom();
  } catch (err) {
    console.error("å‘é€æ¶ˆæ¯æ—¶å‡ºé”™:", err);
  } finally {
    // å®Œæˆåé‡ç½®å‘é€çŠ¶æ€
    isSending.value = false;
  }
}

// æ ¼å¼åŒ–æ–‡æœ¬ï¼ˆä½¿ç”¨ markdown-it å¤„ç† Markdownï¼‰
function formatText(text: string) {
  if (!text) return '';

  // ä¸ºç¡®ä¿ä»£ç å—æ­£ç¡®æ¸²æŸ“ï¼Œå…ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦
  let processedText = text
    // ç¡®ä¿ä»£ç å—ä¸­çš„åå¼•å·è¢«æ­£ç¡®å¤„ç†
    .replace(/```([a-z]*)\n([\s\S]*?)```/g, (match, lang, code) => {
      // æ›¿æ¢ä»£ç ä¸­å¯èƒ½å¯¼è‡´HTMLè§£æé—®é¢˜çš„å­—ç¬¦
      const safeCode = code
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      return `\`\`\`${lang}\n${safeCode}\`\`\``;
    });

  // æ¸²æŸ“markdown
  const rendered = md.render(processedText);

  // ç¡®ä¿ä»£ç å—å…·æœ‰æ­£ç¡®çš„æ ·å¼å’Œç±»å
  return rendered
    // æ”¹è¿›ä»£ç å—çš„CSSç±»
    .replace(/<pre class="hljs/g, '<pre class="hljs code-block')
    // æ·»åŠ è¡Œå·å’Œå¤åˆ¶æŒ‰é’®ç­‰å¢å¼ºåŠŸèƒ½
    .replace(/<pre class="hljs code-block([^>]*)><code>/g,
      '<pre class="hljs code-block$1"><div class="code-header"><span class="language-badge">$1</span></div><code>');
}

// åœ¨script setupéƒ¨åˆ†æ·»åŠ å¤åˆ¶ç›¸å…³çš„ä»£ç 
const copySuccess = ref(false);

// å¤åˆ¶æ¶ˆæ¯å†…å®¹
async function copyMessage(text: string) {
  try {
    // ç§»é™¤HTMLæ ‡ç­¾ï¼Œåªå¤åˆ¶çº¯æ–‡æœ¬
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = formatText(text);
    const plainText = tempDiv.textContent || tempDiv.innerText || '';

    await navigator.clipboard.writeText(plainText);
    copySuccess.value = true;

    // 3ç§’åé‡ç½®å¤åˆ¶çŠ¶æ€
    setTimeout(() => {
      copySuccess.value = false;
    }, 3000);
  } catch (err) {
    console.error('å¤åˆ¶å¤±è´¥:', err);
  }
}

// è·å–çƒ­æœè¯é¢˜
async function fetchHotTopics() {
  try {
    isLoadingHotTopics.value = true;
    // ä½¿ç”¨å…¬å¼€çš„ç¬¬ä¸‰æ–¹APIï¼Œæ­¤APIä»…ä¾›ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶å¯èƒ½éœ€è¦æ›¿æ¢
    const response = await axios.get('https://api.vvhan.com/api/hotlist/all');
    if (response.data && response.data.data) {
      // æŸ¥æ‰¾çƒ­é—¨å¹³å°æ•°æ®ï¼Œä¾‹å¦‚å¾®åšæˆ–çŸ¥ä¹
      const platforms = ['å¾®åš', 'çŸ¥ä¹çƒ­æ¦œ', 'ç™¾åº¦çƒ­ç‚¹'];
      let hotPlatform = null;

      // å¯»æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„å¹³å°
      for (const platform of platforms) {
        hotPlatform = response.data.data.find((item: any) => item.name === platform);
        if (hotPlatform && hotPlatform.data && Array.isArray(hotPlatform.data)) {
          break;
        }
      }

      if (hotPlatform && hotPlatform.data && Array.isArray(hotPlatform.data)) {
        // ä»å¹³å°æ•°æ®ä¸­æå–å‰6ä¸ªçƒ­ç‚¹è¯é¢˜
        hotTopics.value = hotPlatform.data.slice(0, 6).map((item: any) => {
          // æ ¹æ®å®é™…æ•°æ®ç»“æ„æå–æ ‡é¢˜ - å¯èƒ½æ˜¯title, contentæˆ–å…¶ä»–å­—æ®µ
          return item.title || item.content || item.desc || item.text || 'çƒ­é—¨è¯é¢˜';
        });
      } else {
        // å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•å¹³å°æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤è¯é¢˜
        useDefaultTopics();
      }
    } else {
      // APIè¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œä½¿ç”¨é»˜è®¤è¯é¢˜
      useDefaultTopics();
    }
  } catch (error) {
    console.error('è·å–çƒ­æœè¯é¢˜å¤±è´¥:', error);
    // æä¾›ä¸€äº›é»˜è®¤è¯é¢˜
    useDefaultTopics();
  } finally {
    isLoadingHotTopics.value = false;
  }
}

// è¾…åŠ©å‡½æ•°ï¼šä½¿ç”¨é»˜è®¤çƒ­é—¨è¯é¢˜
function useDefaultTopics() {
  hotTopics.value = [
    "äººå·¥æ™ºèƒ½æœ€æ–°åº”ç”¨",
    "å¦‚ä½•æé«˜å·¥ä½œæ•ˆç‡",
    "å¯å†ç”Ÿèƒ½æºçš„å‘å±•",
    "å¥åº·ç”Ÿæ´»æ–¹å¼å»ºè®®",
    "æ·±åº¦å­¦ä¹ ç®—æ³•è§£æ",
    "å…ƒå®‡å®™æœªæ¥å±•æœ›"
  ];
}

// éšæœºåŒ–çƒ­é—¨è¯é¢˜æ•°ç»„é¡ºåº
function randomizeHotTopics() {
  // ä½¿ç”¨Fisher-Yatesæ´—ç‰Œç®—æ³•éšæœºæ’åºæ•°ç»„
  const array = [...hotTopics.value];
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  hotTopics.value = array;
}

// åˆ·æ–°çƒ­é—¨è¯é¢˜ï¼šå¯ä»¥è·å–æ–°è¯é¢˜æˆ–éšæœºæ’åºå½“å‰è¯é¢˜
async function refreshHotTopics() {
  if (Math.random() > 0.5) {
    // 50%æ¦‚ç‡é‡æ–°è·å–è¯é¢˜
    await fetchHotTopics();
  } else {
    // 50%æ¦‚ç‡éšæœºæ’åºå½“å‰è¯é¢˜
    randomizeHotTopics();
  }
}

// ç®€å•çš„é˜²æŠ–å‡½æ•°
function createDebounce(fn: Function, delay: number) {
  let timer: number | null = null;
  return function(...args: any[]) {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => {
      fn(...args);
      timer = null;
    }, delay) as unknown as number;
  }
}
</script>

<style scoped>
/* Markdown ä¼˜åŒ–æ ·å¼ - é«˜çº§ç®€çº¦é£æ ¼ */
:deep(.markdown-body) {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
  font-size: 15px;
  line-height: 1.7;
  word-wrap: break-word;
  color: #24292e;
  max-width: 100%;
}

:deep(.markdown-body h1),
:deep(.markdown-body h2),
:deep(.markdown-body h3),
:deep(.markdown-body h4),
:deep(.markdown-body h5),
:deep(.markdown-body h6) {
  margin-top: 28px;
  margin-bottom: 18px;
  font-weight: 600;
  line-height: 1.3;
  letter-spacing: -0.01em;
  color: #1a202c;
}

:deep(.markdown-body h1) {
  font-size: 1.9em;
  padding-bottom: 0.3em;
  border-bottom: 1px solid #edf2f7;
}

:deep(.markdown-body h2) {
  font-size: 1.5em;
  padding-bottom: 0.3em;
  border-bottom: 1px solid #edf2f7;
}

:deep(.markdown-body h3) {
  font-size: 1.25em;
}

:deep(.markdown-body h4) {
  font-size: 1em;
}

:deep(.markdown-body h5) {
  font-size: 0.875em;
}

:deep(.markdown-body h6) {
  font-size: 0.85em;
  color: #4a5568;
}

:deep(.markdown-body p) {
  margin-top: 0;
  margin-bottom: 18px;
}

:deep(.markdown-body ul),
:deep(.markdown-body ol) {
  padding-left: 2em;
  margin-top: 0;
  margin-bottom: 18px;
}

:deep(.markdown-body ul) {
  list-style-type: disc;
}

:deep(.markdown-body ol) {
  list-style-type: decimal;
}

:deep(.markdown-body li) {
  margin-top: 0.35em;
  margin-bottom: 0.35em;
}

:deep(.markdown-body blockquote) {
  padding: 0.75em 1em;
  margin-left: 0;
  margin-right: 0;
  margin-bottom: 18px;
  color: #4a5568;
  background-color: #f8fafc;
  border-left: 4px solid #e2e8f0;
  border-radius: 0 4px 4px 0;
}

:deep(.markdown-body pre) {
  margin-top: 0;
  margin-bottom: 18px;
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.5;
  background-color: #f8fafc;
  border-radius: 6px;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
}

:deep(.markdown-body code) {
  padding: 0.2em 0.4em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(226, 232, 240, 0.5);
  border-radius: 4px;
  font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
}

:deep(.markdown-body pre code) {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

:deep(.markdown-body table) {
  border-spacing: 0;
  border-collapse: collapse;
  margin-top: 0;
  margin-bottom: 18px;
  width: 100%;
  overflow: auto;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  border-radius: 6px;
}

:deep(.markdown-body table th) {
  font-weight: 600;
  padding: 8px 14px;
  border: 1px solid #e2e8f0;
  background-color: #f8fafc;
}

:deep(.markdown-body table td) {
  padding: 8px 14px;
  border: 1px solid #e2e8f0;
}

:deep(.markdown-body table tr) {
  background-color: #fff;
  border-top: 1px solid #e2e8f0;
  transition: background-color 0.2s ease;
}

:deep(.markdown-body table tr:nth-child(2n)) {
  background-color: #f8fafc;
}

:deep(.markdown-body table tr:hover) {
  background-color: #f1f5f9;
}

:deep(.markdown-body img) {
  max-width: 100%;
  box-sizing: content-box;
  background-color: #fff;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

:deep(.markdown-body a) {
  color: #4299e1;
  text-decoration: none;
  transition: color 0.2s ease;
}

:deep(.markdown-body a:hover) {
  color: #3182ce;
  text-decoration: underline;
}

:deep(.markdown-body hr) {
  height: 1px;
  padding: 0;
  margin: 24px 0;
  background-color: #e2e8f0;
  border: 0;
}

:deep(.hljs) {
  background: #f8fafc !important;
  color: #2d3748 !important;
  border-radius: 6px;
}

/* èŠå¤©ç•Œé¢æ ·å¼ - ç°ä»£é«˜çº§é£æ ¼ */
.chat-container {
  padding: 1.75rem;
  overflow-y: auto;
  height: 100%;
  scrollbar-width: thin;
  scrollbar-color: rgba(203, 213, 225, 0.5) transparent;
}

.chat-container::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

.chat-container::-webkit-scrollbar-track {
  background: transparent;
}

.chat-container::-webkit-scrollbar-thumb {
  background-color: rgba(203, 213, 225, 0.5);
  border-radius: 6px;
}

/* ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
div[v-for="(item, index) in conversationHistory"] div:nth-child(1) div:nth-child(2).rounded-2xl.shadow-sm {
  background: linear-gradient(135deg, #9333ea, #7e22ce) !important;
  color: white !important;
  box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15) !important;
  border-top-right-radius: 4px !important;
}

/* ç”¨æˆ·æ¶ˆæ¯æ–‡æœ¬é¢œè‰² */
div[v-for="(item, index) in conversationHistory"] div:nth-child(1) div:nth-child(2) div.text-gray-800 {
  color: rgba(255, 255, 255, 0.95) !important;
}

/* ç”¨æˆ·è§’è‰²æ–‡æœ¬ */
div[v-for="(item, index) in conversationHistory"] div:nth-child(1) div:nth-child(2) div.text-purple-700 {
  color: rgba(255, 255, 255, 0.85) !important;
}

/* AIæ¶ˆæ¯æ°”æ³¡æ ·å¼ */
div[v-for="(item, index) in conversationHistory"] div:nth-child(1) div:nth-child(2).rounded-2xl.shadow-sm:not([class*="from-purple"]) {
  background: white !important;
  border: 1px solid #e5e7eb !important;
  box-shadow: 0 4px 12px rgba(148, 163, 184, 0.1) !important;
  border-top-left-radius: 4px !important;
}

/* ç”¨æˆ·å¤´åƒèƒŒæ™¯ */
div.w-10.h-10.rounded-full.flex.items-center.justify-center.flex-shrink-0.text-xl.bg-gradient-to-r.from-purple-400.to-purple-600 {
  background: linear-gradient(135deg, #9333ea, #7e22ce) !important;
  box-shadow: 0 3px 8px rgba(124, 58, 237, 0.25) !important;
}

/* AIå¤´åƒèƒŒæ™¯ */
div.w-10.h-10.rounded-full.flex.items-center.justify-center.flex-shrink-0.text-xl.bg-gradient-to-r.from-blue-400.to-blue-600 {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
  box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25) !important;
}

/* æ€ç»´è¿‡ç¨‹æ ·å¼ä¼˜åŒ– */
.thinking-process {
  @apply bg-gradient-to-br from-slate-50 to-white;
}

.thinking-process :deep(.prose) {
  @apply leading-relaxed;
}

.thinking-process :deep(.prose p) {
  @apply text-gray-600 mb-4;
}

.thinking-process :deep(.prose ul),
.thinking-process :deep(.prose ol) {
  @apply my-4 space-y-2;
}

.thinking-process :deep(.prose li) {
  @apply text-gray-600;
}

.thinking-process :deep(.prose strong) {
  @apply text-gray-900 font-semibold;
}

.thinking-process :deep(.prose blockquote) {
  @apply border-l-4 border-purple-200 bg-purple-50/50 text-gray-700 my-4 py-2 px-4 rounded-r-lg;
}

.thinking-process :deep(.prose code) {
  @apply bg-gray-100 text-gray-800 px-1.5 py-0.5 rounded text-sm;
}

.thinking-process :deep(.prose pre) {
  @apply bg-gray-900 text-gray-100 rounded-lg shadow-sm my-4;
}

.thinking-process :deep(.prose h3) {
  @apply text-lg font-semibold text-gray-900 mb-3 mt-6;
}

.thinking-process :deep(.prose h4) {
  @apply text-base font-semibold text-gray-800 mb-2 mt-4;
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes thinking {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.animate-thinking {
  animation: thinking 2s ease-in-out infinite;
}

/* ä»£ç å—å¢å¼ºæ ·å¼ */
:deep(.code-block) {
  margin: 1.25rem 0;
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

:deep(.code-header) {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 1rem;
  background: #0d1117;
  color: #c9d1d9;
  font-family: monospace;
  font-size: 0.8rem;
  border-bottom: 1px solid #30363d;
}

:deep(.language-badge) {
  display: inline-block;
  padding: 0.1rem 0.5rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
  color: #e6edf3;
  text-transform: lowercase;
}

:deep(.hljs) {
  background: #0d1117 !important;
  color: #c9d1d9 !important;
  padding: 1rem !important;
  border-radius: 0 !important;
  font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace !important;
  font-size: 0.9rem !important;
  line-height: 1.5 !important;
  tab-size: 2;
}

:deep(.hljs-keyword),
:deep(.hljs-built_in),
:deep(.hljs-type) {
  color: #ff7b72 !important;
}

:deep(.hljs-string),
:deep(.hljs-regexp) {
  color: #a5d6ff !important;
}

:deep(.hljs-title),
:deep(.hljs-attr),
:deep(.hljs-selector-id),
:deep(.hljs-selector-class) {
  color: #d2a8ff !important;
}

:deep(.hljs-comment),
:deep(.hljs-quote) {
  color: #8b949e !important;
  font-style: italic;
}

:deep(.hljs-doctag),
:deep(.hljs-meta),
:deep(.hljs-meta-keyword) {
  color: #ff7b72 !important;
}

:deep(.hljs-variable),
:deep(.hljs-template-variable) {
  color: #ffa657 !important;
}

/* ä¿®å¤ä»£ç å—å†…è¡Œé«˜å’Œè¾¹è· */
:deep(.markdown-body pre code) {
  white-space: pre;
  tab-size: 2;
  font-size: 0.9rem;
  line-height: 1.6;
}

/* èŠå¤©æ¶ˆæ¯ä¸­çš„ä»£ç å—è°ƒæ•´ */
.prose :deep(.code-block) {
  margin: 0.75rem 0;
}

/* æ€è€ƒçŠ¶æ€æç¤ºæ¡†åŠ¨ç”» */
@keyframes pulse-soft {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.animate-pulse {
  animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* æ‰“å­—æŒ‡ç¤ºå™¨çƒä½“åŠ¨ç”»ä¼˜åŒ– */
@keyframes bounce-subtle {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

.animate-bounce {
  animation: bounce-subtle 1.2s infinite;
}

/* æ¶ˆæ¯è½¬åœºåŠ¨ç”» */
.chat-container > div {
  transition: all 0.3s ease;
}

/* ç‚¹å‡»åé¦ˆæ•ˆæœ */
button,
.cursor-pointer {
  transition: transform 0.1s ease;
}

button:active,
.cursor-pointer:active {
  transform: scale(0.98);
}

/* æ€è€ƒçŠ¶æ€æŒ‡ç¤ºå™¨çš„é—ªçƒæ•ˆæœ */
@keyframes glow {
  0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
  50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.8); }
}

.thinking-indicator {
  animation: glow 1.5s ease-in-out infinite;
}
</style>


